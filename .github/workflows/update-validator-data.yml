name: Update Validator Data from TicsScan

on:
  schedule:
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ”Ñ‚ÑŒÑÑ ĞºĞ¾Ğ¶Ğ½Ñ– 5 Ñ…Ğ²Ğ¸Ğ»Ğ¸Ğ½
    - cron: '*/5 * * * *'
  workflow_dispatch: # ĞœĞ¾Ğ¶Ğ½Ğ° Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğ¸ Ğ²Ñ€ÑƒÑ‡Ğ½Ñƒ

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Fetch validator data from Cosmos API
        run: |
          echo "ğŸ“¡ Fetching validator data from Cosmos API..."
          
          VALIDATOR="qubeticsvaloper1tzk9f84cv2gmk3du3m9dpxcuph70sfj6uf6kld"
          API_BASE="https://api.qubetics.com"
          
          # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ²Ğ°Ğ»Ñ–Ğ´Ğ°Ñ‚Ğ¾Ñ€Ğ°
          VALIDATOR_DATA=$(curl -s "${API_BASE}/cosmos/staking/v1beta1/validators/${VALIDATOR}" || echo '{}')
          
          # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´ĞµĞ»ĞµĞ³Ğ°Ñ†Ñ–Ñ—
          DELEGATIONS_DATA=$(curl -s "${API_BASE}/cosmos/staking/v1beta1/validators/${VALIDATOR}/delegations?pagination.limit=1000" || echo '{}')
          
          # ĞŸĞ°Ñ€ÑĞ¸Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ–
          TOKENS=$(echo "$VALIDATOR_DATA" | jq -r '.validator.tokens // "0"')
          COMMISSION=$(echo "$VALIDATOR_DATA" | jq -r '.validator.commission.commission_rates.rate // "0.05"')
          JAILED=$(echo "$VALIDATOR_DATA" | jq -r '.validator.jailed // false')
          STATUS=$(echo "$VALIDATOR_DATA" | jq -r '.validator.status // "UNKNOWN"')
          DELEGATORS=$(echo "$DELEGATIONS_DATA" | jq -r '.delegation_responses | length // 0')
          
          echo "Raw tokens: $TOKENS"
          echo "Commission: $COMMISSION"
          echo "Delegators: $DELEGATORS"
          
          # Ğ¯ĞºÑ‰Ğ¾ API Ğ½Ğµ Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½ÑƒĞ² Ğ´Ğ°Ğ½Ñ–, Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ fallback
          if [ "$TOKENS" = "0" ] || [ "$TOKENS" = "null" ]; then
            echo "âš ï¸ API unavailable, using fallback data"
            
            cat > data/validator-stats.json << 'EOF'
{
  "updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "validator": "qubeticsvaloper1tzk9f84cv2gmk3du3m9dpxcuph70sfj6uf6kld",
  "totalDelegated": "9.7M",
  "totalDelegatedRaw": 9727594110000,
  "delegatorsCount": 150,
  "commissionRate": "5.00%",
  "commissionRateRaw": 0.05,
  "uptime": "99.8%",
  "currentBlock": "2049979",
  "isActive": true,
  "jailed": false,
  "status": "BOND_STATUS_BONDED",
  "source": "fallback"
}
EOF
          else
            echo "âœ… API data received successfully"
            
            # ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½Ğ¸ Ğ· uTICS Ğ² TICS
            TOTAL_TICS=$(echo "scale=2; $TOKENS / 1000000" | bc)
            
            # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ² M Ğ°Ğ±Ğ¾ K
            if (( $(echo "$TOTAL_TICS >= 1000000" | bc -l) )); then
              FORMATTED=$(echo "scale=1; $TOTAL_TICS / 1000000" | bc)"M"
            elif (( $(echo "$TOTAL_TICS >= 1000" | bc -l) )); then
              FORMATTED=$(echo "scale=1; $TOTAL_TICS / 1000" | bc)"K"
            else
              FORMATTED=$(printf "%.0f" $TOTAL_TICS)
            fi
            
            # ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ ĞºĞ¾Ğ¼Ñ–ÑÑ–Ñ Ğ² Ğ²Ñ–Ğ´ÑĞ¾Ñ‚ĞºĞ¸
            COMMISSION_PERCENT=$(echo "scale=2; $COMMISSION * 100" | bc)
            
            # Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑ
            if [ "$JAILED" = "false" ] && [ "$STATUS" = "BOND_STATUS_BONDED" ]; then
              IS_ACTIVE="true"
            else
              IS_ACTIVE="false"
            fi
            
            # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¸Ğ¹ Ğ±Ğ»Ğ¾Ğº
            BLOCK=$(curl -s https://rpc.qubetics.com/status 2>/dev/null | jq -r '.result.sync_info.latest_block_height // empty' 2>/dev/null || echo "")
            if [ -z "$BLOCK" ]; then
              BLOCK="2049979"
            fi
            
            # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ñƒ Ğ´Ğ°Ñ‚Ñƒ Ñ‚Ğ° Ñ‡Ğ°Ñ
            UPDATED=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ JSON Ñ„Ğ°Ğ¹Ğ» Ğ· Ğ´Ğ°Ğ½Ğ¸Ğ¼Ğ¸
            cat > data/validator-stats.json << EOF
{
  "updated": "$UPDATED",
  "validator": "$VALIDATOR",
  "totalDelegated": "$FORMATTED",
  "totalDelegatedRaw": $TOKENS,
  "delegatorsCount": $DELEGATORS,
  "commissionRate": "${COMMISSION_PERCENT}%",
  "commissionRateRaw": $COMMISSION,
  "uptime": "99.8%",
  "currentBlock": "$BLOCK",
  "isActive": $IS_ACTIVE,
  "jailed": $JAILED,
  "status": "$STATUS",
  "source": "cosmos-api"
}
EOF
          fi
          
          echo "ğŸ“ Data saved to validator-stats.json:"
          cat data/validator-stats.json
          
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/validator-stats.json
          
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ‡Ğ¸ Ñ” Ğ·Ğ¼Ñ–Ğ½Ğ¸
          if git diff --staged --quiet; then
            echo "âœ… No changes detected"
          else
            echo "ğŸ“¤ Changes detected, committing..."
            git commit -m "Auto-update validator stats from Cosmos API"
            git push
            echo "âœ… Changes pushed successfully"
          fi

